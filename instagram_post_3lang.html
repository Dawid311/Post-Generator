<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <ti    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
      <a class="dl" id="dlGifDE" download="instagram_post_DE.gif" style="background:#28a745; border-color:#28a745;">🇩🇪 Download DE GIF</a>
      <a class="dl" id="dlGifPL" download="instagram_post_PL.gif" style="background:#dc3545; border-color:#dc3545;">🇵🇱 Download PL GIF</a>
      <a class="dl" id="dlGifEN" download="instagram_post_EN.gif" style="background:#007bff; border-color:#007bff;">🇬🇧 Download EN GIF</a>
    </div>
    <div style="margin: 15px 0;">
      <video id="videoPreview" controls style="max-width:260px; border:2px solid var(--gold); border-radius:12px;" autoplay muted loop></video>
    </div>
    <div style="margin-bottom: 15px;">
      <a class="dl" id="dlMp4" download="instagram_post_3lang_sequence.mp4" style="background:var(--gold); color:#000; border-color:var(--gold); font-size:1.1rem;">🎵 Download 6s Sequenz MP4 (DE→PL→EN + Audio)</a>
    </div>nstagram Post - 3 Sprachen Loop</title>
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">
  <style>
    :root { --gold:#ffd700; }
    body { margin:0; font-family:'Pirata One',cursive; background:linear-gradient(135deg,#232526 0%,#1e2a38 100%); color:#fff; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:24px; padding:36px 20px 48px; box-sizing:border-box; }
    h1 { font-size:1.4rem; letter-spacing:2px; color:var(--gold); margin:0; text-shadow:0 2px 12px #000; text-align:center; }
    .card { position:relative; width:440px; max-width:95vw; background:rgba(30,40,50,.97); border-radius:18px; overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,0.5), 0 0 0 2px rgba(255,215,0,0.1); }
    .hero-image { width:100%; height:260px; background-size:cover; background-position:center; background-repeat:no-repeat; position:relative; filter:brightness(.85) grayscale(.1); background-image: url('_ARC6946.jpg'); }
    .heute-badge { position:absolute; top:15px; right:15px; background:linear-gradient(45deg, #ff6b6b, #ffd93d); color:#000; font-size:0.9rem; font-weight:bold; padding:8px 16px; border-radius:20px; text-transform:uppercase; letter-spacing:1px; box-shadow:0 4px 12px rgba(255,107,107,0.4); z-index:10; animation: pulseBadge 1s infinite ease-in-out; }
    .card-content { padding:32px 24px 24px; text-align:center; position:relative; }
    .title { font-size:2.4rem; color:var(--gold); letter-spacing:2px; margin:0 0 12px; text-shadow:0 2px 16px #000a; display:flex; align-items:center; justify-content:center; gap:15px; }
    .title .music-note { font-size:1.8rem; }
    .subtitle { font-size:1.3rem; margin:0 0 18px; text-shadow:0 2px 8px #ffd70090; }
    .details { font-size:1.1rem; color:#b8c6db; letter-spacing:1px; margin:0 0 18px; position:relative; }
    .details::before { content:"⏰"; margin-right:8px; color:var(--gold); }
    .cta { display:inline-block; background:linear-gradient(90deg,var(--gold),#fff); color:#232526; font-size:1.25rem; padding:12px 34px; border-radius:32px; letter-spacing:2px; text-transform:uppercase; box-shadow:0 2px 16px #ffd700a0, 0 0 20px rgba(255,215,0,0.3); position:relative; }
    .cta::before { content:"🎸"; margin-right:8px; }
    .live-indicator { position:absolute; top:-5px; right:-5px; width:12px; height:12px; background:#ff4757; border-radius:50%; animation: blinkDot 1s infinite ease-in-out; }
    
    @keyframes pulseBadge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes blinkDot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }
    
    /* Sprach-Animation alle 2 Sekunden */
    .language-cycle {
      animation: languageSwitch 6s infinite steps(1);
    }
    
    @keyframes languageSwitch {
      0%, 33.33% { /* Deutsch */ }
      33.34%, 66.66% { /* Polnisch */ }
      66.67%, 100% { /* Englisch */ }
    }
    
    .status { font-size:.8rem; letter-spacing:1px; min-height:1rem; }
    .hidden { display:none!important; }
    .result { display:flex; flex-direction:column; align-items:center; gap:8px; }
    a.dl { background:#4CAF50; border:2px solid #4CAF50; color:white; padding:12px 24px; border-radius:12px; text-decoration:none; letter-spacing:1px; font-size:1rem; transition:.25s; }
    a.dl:hover { background:#45a049; box-shadow:0 0 12px #4CAF50; }
    .previewWrap { display:flex; flex-direction:column; align-items:center; gap:6px; }
    .note { font-size:.6rem; opacity:.55; text-align:center; max-width:520px; line-height:1.3; }
    .spinner { width:52px; height:52px; border:5px solid #ffffff22; border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .progress-container { width:100%; max-width:400px; background:#16212b; border-radius:10px; padding:8px; margin:16px 0; }
    .progress-bar { height:12px; background:linear-gradient(90deg,var(--gold),#fff); border-radius:6px; transition:width 0.3s ease; width:0%; }
    .progress-text { color:var(--gold); font-size:0.9rem; text-align:center; margin-top:8px; }
    
    .lang-preview { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); color:var(--gold); padding:4px 8px; border-radius:8px; font-size:0.7rem; z-index:20; }
  </style>
</head>
<body>
  <h1>Instagram Post - 3 Sprachen Parallel Rendering</h1>
  <div class="status" id="status">Lade...</div>
  <button onclick="location.reload()" style="background:#666; color:white; border:none; padding:8px 16px; border-radius:5px; margin:10px; cursor:pointer; font-size:12px;">🔄 Neu starten</button>
  
  <!-- 3 Bereiche nebeneinander für paralleles Rendering -->
  <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
    
    <!-- DEUTSCH -->
    <div class="card" id="cardDE" style="flex-shrink: 0;">
      <div class="hero-image">
        <div class="lang-preview" style="background: #28a745;">DE</div>
        <div class="heute-badge">🔥 HEUTE 🔥</div>
      </div>
      <div class="card-content">
        <div class="title">
          <span class="music-note">🎵</span>
          <span>KONZERT</span>
          <span class="music-note">🎵</span>
        </div>
        <div class="subtitle">22.08 • 19:00 Uhr</div>
        <div class="details">Katys Garage, Dresden Neustadt<br>Live-Musik & Atmosphäre</div>
        <div class="cta">
          Sei dabei!
          <div class="live-indicator"></div>
        </div>
      </div>
    </div>
    
    <!-- POLNISCH -->
    <div class="card" id="cardPL" style="flex-shrink: 0;">
      <div class="hero-image">
        <div class="lang-preview" style="background: #dc3545;">PL</div>
        <div class="heute-badge">🔥 DZISIAJ 🔥</div>
      </div>
      <div class="card-content">
        <div class="title">
          <span class="music-note">🎵</span>
          <span>KONCERT</span>
          <span class="music-note">🎵</span>
        </div>
        <div class="subtitle">22.08 • 19:00</div>
        <div class="details">Katys Garage, Dresden Neustadt<br>Muzyka na żywo & Atmosfera</div>
        <div class="cta">
          Bądź tam!
          <div class="live-indicator"></div>
        </div>
      </div>
    </div>
    
    <!-- ENGLISCH -->
    <div class="card" id="cardEN" style="flex-shrink: 0;">
      <div class="hero-image">
        <div class="lang-preview" style="background: #007bff;">EN</div>
        <div class="heute-badge">🔥 TODAY 🔥</div>
      </div>
      <div class="card-content">
        <div class="title">
          <span class="music-note">🎵</span>
          <span>CONCERT</span>
          <span class="music-note">🎵</span>
        </div>
        <div class="subtitle">22.08 • 7:00 PM</div>
        <div class="details">Katys Garage, Dresden Neustadt<br>Live Music & Atmosphere</div>
        <div class="cta">
          Be there!
          <div class="live-indicator"></div>
        </div>
      </div>
    </div>
    
  </div>
  <div class="spinner" id="spinner"></div>
  <div class="progress-container hidden" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
    <div class="progress-text" id="progressText">0%</div>
  </div>
  <div class="result hidden" id="result">
    <div class="previewWrap">
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <img id="gifPreviewDE" style="max-width:150px; border:2px solid #28a745; border-radius:8px;" />
        <img id="gifPreviewPL" style="max-width:150px; border:2px solid #dc3545; border-radius:8px;" />
        <img id="gifPreviewEN" style="max-width:150px; border:2px solid #007bff; border-radius:8px;" />
      </div>
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
      <a class="dl" id="dlGifDE" download="instagram_post_DE.gif" style="background:#28a745; border-color:#28a745;">🇩🇪 Download DE GIF</a>
      <a class="dl" id="dlGifPL" download="instagram_post_PL.gif" style="background:#dc3545; border-color:#dc3545;">🇵� Download PL GIF</a>
      <a class="dl" id="dlGifEN" download="instagram_post_EN.gif" style="background:#007bff; border-color:#007bff;">🇬🇧 Download EN GIF</a>
    </div>
    <div style="margin-top:12px;">
      <audio id="syncAudio" controls style="width:100%; max-width:280px;">
        <source src="Katze_30sek.mp3" type="audio/mpeg">
        Audio-Track (30s) - wird mit 6s Sequenz kombiniert
      </audio>
    </div>
  </div>
  <p class="note">Export startet automatisch. 3 separate 2s GIFs werden erstellt und dann zu 6s Sequenz (DE→PL→EN) mit 30s Audio kombiniert! Einzelne GIFs + kombiniertes MP4 verfügbar.</p>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
  <script>
    async function createGIF(targetElement, language) {
      const gif = new GIF({
        workers: 2,
        quality: 10,
        width: 1080,
        height: 1350,
        repeat: 0, // Endlos-Loop
        workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'
      });
      
      // 2 Sekunden Animation (30 FPS = 60 Frames)
      const fps = 30;
      const animationDuration = 2;
      const totalFrames = fps * animationDuration;
      const frameDelay = 1000 / fps; // ~33ms pro Frame
      
      // CSS-Animationen temporär deaktivieren für Frame-Erfassung
      const style = document.createElement('style');
      style.textContent = `
        .heute-badge { animation: none !important; }
        .live-indicator { animation: none !important; }
      `;
      document.head.appendChild(style);
      
      for(let i = 0; i < totalFrames; i++) {
        const timeProgress = i / (totalFrames - 1); // 0 bis 1 über 2s
        
        // HEUTE Badge Pulsing (2 komplette Zyklen in 2s)
        const badgeScale = 1 + 0.05 * Math.sin(timeProgress * Math.PI * 4);
        targetElement.querySelector('.heute-badge').style.transform = `scale(${badgeScale})`;
        
        // Live-Indicator Blinking (2 komplette Zyklen in 2s)
        const dotOpacity = 0.6 + 0.4 * Math.sin(timeProgress * Math.PI * 4);
        targetElement.querySelector('.live-indicator').style.opacity = dotOpacity;
        
        // Kurz warten für DOM-Update
        await new Promise(r=>setTimeout(r, 16));
        
        // Frame mit html2canvas erfassen
        const canvas = await html2canvas(targetElement, {
          backgroundColor: null,
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: false
        });
        
        // Frame auf finale Größe bringen
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = 1080;
        finalCanvas.height = 1350;
        const ctx = finalCanvas.getContext('2d');
        
        // Gradient-Hintergrund
        const grd = ctx.createLinearGradient(0,0,1080,1350);
        grd.addColorStop(0,'#232526');
        grd.addColorStop(1,'#1e2a38');
        ctx.fillStyle = grd;
        ctx.fillRect(0,0,1080,1350);
        
        // Content zentriert
        const scale = Math.min(1080 * 0.9 / canvas.width, 1350 * 0.7 / canvas.height);
        const drawW = canvas.width * scale;
        const drawH = canvas.height * scale;
        const dx = (1080 - drawW) / 2;
        const dy = (1350 - drawH) / 2;
        
        ctx.drawImage(canvas, dx, dy, drawW, drawH);
        
        // Frame zum GIF hinzufügen
        gif.addFrame(finalCanvas, {delay: frameDelay});
      }
      
      // CSS-Animationen wieder aktivieren
      document.head.removeChild(style);
      
      return new Promise((resolve) => {
        gif.on('finished', function(blob) {
          resolve(blob);
        });
        gif.render();
      });
    }
    
    async function autoExport(){
      const statusEl=document.getElementById('status');
      const spinner=document.getElementById('spinner');
      const progressContainer=document.getElementById('progressContainer');
      const progressBar=document.getElementById('progressBar');
      const progressText=document.getElementById('progressText');
      const result=document.getElementById('result');
      
      try {
        statusEl.textContent='3 parallele GIFs werden erstellt...';
        await (document.fonts?.ready||Promise.resolve());
        await new Promise(r=>setTimeout(r,1000));
        
        // Progress Bar anzeigen
        spinner.classList.add('hidden');
        progressContainer.classList.remove('hidden');
        
        const languages = [
          { element: document.getElementById('cardDE'), preview: document.getElementById('gifPreviewDE'), download: document.getElementById('dlGifDE'), name: 'DE' },
          { element: document.getElementById('cardPL'), preview: document.getElementById('gifPreviewPL'), download: document.getElementById('dlGifPL'), name: 'PL' },
          { element: document.getElementById('cardEN'), preview: document.getElementById('gifPreviewEN'), download: document.getElementById('dlGifEN'), name: 'EN' }
        ];
        
        // Alle 3 GIFs parallel erstellen
        for(let i = 0; i < languages.length; i++) {
          const lang = languages[i];
          const progress = ((i + 1) / languages.length) * 100;
          
          progressBar.style.width = progress + '%';
          progressText.textContent = `${Math.round(progress)}% - ${lang.name} GIF wird erstellt...`;
          statusEl.textContent = `${lang.name} GIF wird gerendert...`;
          
          const blob = await createGIF(lang.element, lang.name);
          const url = URL.createObjectURL(blob);
          
          lang.download.href = url;
          lang.preview.src = url;
        }
        
        result.classList.remove('hidden');
        progressContainer.classList.add('hidden');
        statusEl.textContent = '3 GIFs fertig! Einzeln oder kombiniert verwendbar.';
        
        // Auto-Download aller 3 GIFs
        setTimeout(() => {
          languages.forEach((lang, index) => {
            setTimeout(() => lang.download.click(), index * 500);
          });
        }, 400);
        
        // Nach GIF-Erstellung MP4-Sequenz erstellen
        setTimeout(() => createMP4Sequence(languages), 2000);
        
      } catch(e){ 
        console.error(e); 
        statusEl.textContent='Fehler: '+e.message; 
        spinner.classList.add('hidden'); 
        progressContainer.classList.add('hidden');
      }
    }
    
    // MP4-Sequenz aus den 3 GIFs erstellen
    async function createMP4Sequence(languages) {
      const statusEl = document.getElementById('status');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const dlMp4 = document.getElementById('dlMp4');
      const videoPreview = document.getElementById('videoPreview');
      
      try {
        statusEl.textContent = '6s Sequenz MP4 wird erstellt...';
        progressContainer.classList.remove('hidden');
        
        // Canvas für Video-Stream
        const W = 1080, H = 1350;
        const videoCanvas = document.createElement('canvas');
        videoCanvas.width = W;
        videoCanvas.height = H;
        const videoCtx = videoCanvas.getContext('2d');
        const stream = videoCanvas.captureStream(30);
        
        // Alle GIF-Frames sammeln (DE: 0-59, PL: 60-119, EN: 120-179)
        const allFrames = [];
        
        for(let langIndex = 0; langIndex < 3; langIndex++) {
          const lang = languages[langIndex];
          statusEl.textContent = `${lang.name} Frames werden vorbereitet...`;
          
          // 2s Animation pro Sprache (60 Frames)
          for(let i = 0; i < 60; i++) {
            const timeProgress = i / 59; // 0 bis 1 über 2s
            
            // Badge + Dot Animation
            const badgeScale = 1 + 0.05 * Math.sin(timeProgress * Math.PI * 4);
            lang.element.querySelector('.heute-badge').style.transform = `scale(${badgeScale})`;
            
            const dotOpacity = 0.6 + 0.4 * Math.sin(timeProgress * Math.PI * 4);
            lang.element.querySelector('.live-indicator').style.opacity = dotOpacity;
            
            await new Promise(r=>setTimeout(r, 16));
            
            // Frame erfassen
            const canvas = await html2canvas(lang.element, {
              backgroundColor: null,
              scale: 2,
              useCORS: true,
              allowTaint: true,
              logging: false
            });
            
            // Frame auf finale Größe
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = W;
            finalCanvas.height = H;
            const ctx = finalCanvas.getContext('2d');
            
            // Gradient-Hintergrund
            const grd = ctx.createLinearGradient(0,0,W,H);
            grd.addColorStop(0,'#232526');
            grd.addColorStop(1,'#1e2a38');
            ctx.fillStyle = grd;
            ctx.fillRect(0,0,W,H);
            
            // Content
            const scale = Math.min(W * 0.9 / canvas.width, H * 0.7 / canvas.height);
            const drawW = canvas.width * scale;
            const drawH = canvas.height * scale;
            const dx = (W - drawW) / 2;
            const dy = (H - drawH) / 2;
            
            ctx.drawImage(canvas, dx, dy, drawW, drawH);
            allFrames.push(ctx.getImageData(0, 0, W, H));
          }
          
          const progress = ((langIndex + 1) / 3) * 50;
          progressBar.style.width = progress + '%';
          progressText.textContent = `${Math.round(progress)}% - ${lang.name} Frames erfasst`;
        }
        
        statusEl.textContent = 'MP4 mit Audio wird gerendert...';
        
        // Audio-Element
        const audioElement = new Audio('Katze_30sek.mp3');
        audioElement.currentTime = 0;
        
        let videoChunks = [];
        let mediaRecorder;
        
        try {
          // Audio-Stream
          const audioContext = new AudioContext();
          const audioSource = audioContext.createMediaElementSource(audioElement);
          const audioDestination = audioContext.createMediaStreamDestination();
          audioSource.connect(audioDestination);
          
          // Video + Audio kombinieren
          const combinedStream = new MediaStream([
            ...stream.getVideoTracks(),
            ...audioDestination.stream.getAudioTracks()
          ]);
          
          mediaRecorder = new MediaRecorder(combinedStream, {
            mimeType: 'video/webm',
            videoBitsPerSecond: 4000000
          });
          
          mediaRecorder.ondataavailable = e => videoChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
            const videoUrl = URL.createObjectURL(videoBlob);
            dlMp4.href = videoUrl;
            videoPreview.src = videoUrl;
            
            progressContainer.classList.add('hidden');
            statusEl.textContent = '6s Sequenz MP4 + 30s Audio fertig!';
            
            setTimeout(() => { dlMp4.click(); }, 400);
          };
          
          mediaRecorder.start();
          audioElement.play();
          
        } catch (e) {
          console.warn('Audio nicht verfügbar:', e);
        }
        
        // 30 Sekunden lang 6s Sequenz loopen (5x)
        const totalDuration = 30000;
        const loopDuration = 6000; // 6s (DE+PL+EN)
        const frameTime = loopDuration / allFrames.length; // ~33ms
        const startTime = Date.now();
        
        const animate = () => {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / totalDuration, 1) * 50 + 50; // 50-100%
          
          progressBar.style.width = progress + '%';
          progressText.textContent = `${Math.round(progress)}% - ${(elapsed/1000).toFixed(1)}s / 30s`;
          statusEl.textContent = `Sequenz Video: ${(elapsed/1000).toFixed(1)}s / 30s`;
          
          if (elapsed < totalDuration) {
            // Frame-Index im 6s Loop
            const loopPosition = elapsed % loopDuration;
            const frameIndex = Math.floor(loopPosition / frameTime) % allFrames.length;
            const frameData = allFrames[frameIndex];
            
            videoCtx.putImageData(frameData, 0, 0);
            requestAnimationFrame(animate);
          } else {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
              mediaRecorder.stop();
              audioElement.pause();
            }
          }
        };
        
        animate();
        
      } catch(e) {
        console.error(e);
        statusEl.textContent = 'MP4-Fehler: ' + e.message;
        progressContainer.classList.add('hidden');
      }
    }
    
    // Beim Laden starten
    window.addEventListener('load', () => { 
      setTimeout(autoExport, 500); 
    });
  </script>
</body>
</html>
